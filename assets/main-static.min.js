const POSTS_JSON="/data/posts.json",DEFAULT_CATEGORY_MAPPING={"AI 分析":"ai-analysis","技術開發":"tech-development","技術分析":"tech-analysis","開發哲學":"dev-philosophy","生活記事":"life-stories","商業觀察":"business-insights","文化觀察":"cultural-insights"};let categoryMapping=null;async function loadCategoryMapping(){if(categoryMapping)return categoryMapping;try{const e=await fetch("/config/categories.json"),t=await e.json();return categoryMapping=t.categoryMapping,categoryMapping}catch(e){return console.error("無法載入分類設定，使用預設值",e),categoryMapping=DEFAULT_CATEGORY_MAPPING,categoryMapping}}const ThemeManager={STORAGE_KEY:"theme-preference",THEMES:["light","dark","auto"],init(){const e=localStorage.getItem(this.STORAGE_KEY)||"auto";this.setTheme(e,!1);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{"auto"===this.getCurrentTheme()&&this.applyTheme()})},getCurrentTheme(){return localStorage.getItem(this.STORAGE_KEY)||"auto"},setTheme(e,t=!0){this.THEMES.includes(e)||(e="auto"),t&&localStorage.setItem(this.STORAGE_KEY,e),this.applyTheme(),this.updateToggleButton()},applyTheme(){const e=this.getCurrentTheme(),t=document.documentElement;"auto"===e?t.removeAttribute("data-theme"):t.setAttribute("data-theme",e)},toggle(){const e=this.getCurrentTheme(),t=(this.THEMES.indexOf(e)+1)%this.THEMES.length,n=this.THEMES[t];this.setTheme(n)},updateToggleButton(){const e=document.querySelector(".theme-toggle");if(!e)return;const t=this.getCurrentTheme(),n=e.querySelector(".theme-toggle__icon"),o=e.querySelector(".theme-toggle__text"),a={light:{svg:'<svg class="theme-icon theme-icon--light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <circle cx="12" cy="12" r="5"/>\n          <line x1="12" y1="1" x2="12" y2="3"/>\n          <line x1="12" y1="21" x2="12" y2="23"/>\n          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>\n          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>\n          <line x1="1" y1="12" x2="3" y2="12"/>\n          <line x1="21" y1="12" x2="23" y2="12"/>\n          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>\n          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>\n        </svg>',text:"Light"},dark:{svg:'<svg class="theme-icon theme-icon--dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>\n        </svg>',text:"Dark"},auto:{svg:'<svg class="theme-icon theme-icon--auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M21.5 12c0 5.25-4.25 9.5-9.5 9.5S2.5 17.25 2.5 12 6.75 2.5 12 2.5s9.5 4.25 9.5 9.5z"/>\n          <path d="M12 2.5v19M21.5 12h-19M18.36 5.64l-12.72 12.72M18.36 18.36L5.64 5.64"/>\n        </svg>',text:"Auto"}},i=a[t]||a.auto;n&&(n.innerHTML=i.svg),o&&(o.textContent=i.text)}};async function goToRandomPost(e){e&&e.preventDefault();try{const e=await fetch(POSTS_JSON),t=await e.json();if(!t||0===t.length)return void console.warn("沒有可用的文章");const n=t[Math.floor(Math.random()*t.length)],o=await loadCategoryMapping(),a=`/${o[n.category]||"uncategorized"}/${n.slug}/`;window.location.href=a}catch(e){console.error("載入隨機文章失敗",e)}}function initSearch(){const e=document.querySelector(".search-toggle-btn"),t=document.querySelector(".search-box"),n=document.querySelector("#search-input"),o=document.querySelector("#search-clear");if(!n||!e||!t)return;const a=new URLSearchParams(window.location.search).get("search");let i;function r(){t.hidden=!1,e.setAttribute("aria-expanded","true"),e.classList.add("active"),requestAnimationFrame(()=>{t.classList.add("expanded"),setTimeout(()=>{n.focus()},150)})}function s(){t.classList.remove("expanded"),e.setAttribute("aria-expanded","false"),e.classList.remove("active"),setTimeout(()=>{t.classList.contains("expanded")||(t.hidden=!0)},300)}a&&(n.value=a,o&&(o.hidden=!1),r()),e.addEventListener("click",t=>{t.stopPropagation(),"true"===e.getAttribute("aria-expanded")?s():r()}),n.addEventListener("input",e=>{const t=e.target.value.trim();o&&(o.hidden=!t),clearTimeout(i),i=setTimeout(()=>{redirectToHomeWithSearch(t)},300)}),o&&o.addEventListener("click",()=>{n.value="",o.hidden=!0,redirectToHomeWithSearch(""),n.focus()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&(clearTimeout(i),redirectToHomeWithSearch(n.value.trim())),"Escape"===e.key&&s()}),document.addEventListener("click",o=>{t.contains(o.target)||e.contains(o.target)||n.value.trim()||s()}),t.addEventListener("click",e=>{e.stopPropagation()})}function redirectToHomeWithSearch(e){const t=e?`/?search=${encodeURIComponent(e)}`:"/";window.location.href=t}window.ThemeManager=ThemeManager,window.goToRandomPost=goToRandomPost,document.addEventListener("DOMContentLoaded",()=>{ThemeManager.init(),initSearch(),loadCategoryMapping().catch(e=>{console.warn("[init] failed to load category mapping",e)})});