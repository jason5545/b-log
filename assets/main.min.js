const POSTS_JSON="/data/posts.json",POSTS_ROOT="/content/posts/",GITHUB_USERNAME="jason5545",GITHUB_REPO="b-log";let categoryMapping=null;async function loadCategoryMapping(){if(categoryMapping)return categoryMapping;try{const e=await fetch("/config/categories.json"),t=await e.json();return categoryMapping=t.categoryMapping,categoryMapping}catch(e){return console.error("無法載入分類設定，使用預設值",e),categoryMapping={"AI 分析":"ai-analysis","技術開發":"tech-development","技術分析":"tech-analysis","開發哲學":"dev-philosophy","生活記事":"life-stories"},categoryMapping}}async function readUtf8Text(e){try{const t=await e.arrayBuffer();return new TextDecoder("utf-8",{fatal:!0}).decode(t)}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`UTF-8 decode failed: ${t}`)}}const ThemeManager={STORAGE_KEY:"theme-preference",THEMES:["light","dark","auto"],init(){const e=localStorage.getItem(this.STORAGE_KEY)||"auto";this.setTheme(e,!1);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{"auto"===this.getCurrentTheme()&&this.applyTheme()})},getCurrentTheme(){return localStorage.getItem(this.STORAGE_KEY)||"auto"},setTheme(e,t=!0){this.THEMES.includes(e)||(e="auto"),t&&localStorage.setItem(this.STORAGE_KEY,e),this.applyTheme(),this.updateToggleButton()},applyTheme(){const e=this.getCurrentTheme(),t=document.documentElement;"auto"===e?t.removeAttribute("data-theme"):t.setAttribute("data-theme",e)},toggle(){const e=this.getCurrentTheme(),t=(this.THEMES.indexOf(e)+1)%this.THEMES.length,n=this.THEMES[t];this.setTheme(n)},updateToggleButton(){const e=document.querySelector(".theme-toggle");if(!e)return;const t=this.getCurrentTheme(),n=e.querySelector(".theme-toggle__icon"),o=e.querySelector(".theme-toggle__text"),a={light:{icon:"☀️",text:"淺色"},dark:{icon:"🌙",text:"深色"},auto:{icon:"🔄",text:"自動"}},r=a[t]||a.auto;n&&(n.textContent=r.icon),o&&(o.textContent=r.text)},getThemeIcon(e){const t={light:"☀️",dark:"🌙",auto:"🔄"};return t[e]||t.auto},getThemeText(e){const t={light:"淺色",dark:"深色",auto:"自動"};return t[e]||t.auto}};function initSearch(){const e=document.querySelector(".search-toggle-btn"),t=document.querySelector(".search-box"),n=document.querySelector("#search-input"),o=document.querySelector("#search-clear");if(!n||!e||!t)return void console.warn("[Search] Missing elements:",{searchInput:!!n,searchToggleBtn:!!e,searchBox:!!t});console.log("[Search] Initialized successfully");const a=new URLSearchParams(window.location.search).get("search");let r;function i(){t.hidden=!1,e.setAttribute("aria-expanded","true"),e.classList.add("active"),requestAnimationFrame(()=>{t.classList.add("expanded"),setTimeout(()=>{n.focus()},150)})}function s(){t.classList.remove("expanded"),e.setAttribute("aria-expanded","false"),e.classList.remove("active"),setTimeout(()=>{t.classList.contains("expanded")||(t.hidden=!0)},300)}a&&(n.value=a,o&&(o.hidden=!1),i()),e.addEventListener("click",t=>{console.log("[Search] Toggle button clicked"),t.stopPropagation(),"true"===e.getAttribute("aria-expanded")?s():i()}),n.addEventListener("input",e=>{const t=e.target.value.trim();o&&(o.hidden=!t),clearTimeout(r),r=setTimeout(()=>{updateSearchParams(t)},300)}),o&&o.addEventListener("click",()=>{n.value="",o.hidden=!0,updateSearchParams(""),n.focus()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&(clearTimeout(r),updateSearchParams(n.value.trim())),"Escape"===e.key&&s()}),document.addEventListener("click",o=>{t.contains(o.target)||e.contains(o.target)||n.value.trim()||s()}),t.addEventListener("click",e=>{e.stopPropagation()})}function updateSearchParams(e){const t=new URLSearchParams(window.location.search);e?t.set("search",e):t.delete("search");const n=t.toString()?`${window.location.pathname}?${t.toString()}`:window.location.pathname;window.history.pushState({},"",n),renderHomepage().catch(e=>{console.error("[search] failed to render",e)})}function filterPostsBySearch(e,t){if(!t||!t.trim())return e;const n=t.toLowerCase().trim();return e.filter(e=>!(!e.title||!e.title.toLowerCase().includes(n))||(!(!e.summary||!e.summary.toLowerCase().includes(n))||(!(!e.category||!e.category.toLowerCase().includes(n))||!!Array.isArray(e.tags)&&e.tags.some(e=>String(e||"").toLowerCase().includes(n)))))}function updateSearchResultsCount(e,t){const n=document.querySelector("#search-results-count");n&&(t&&t.trim()?(n.textContent=`找到 ${e} 篇文章`,n.hidden=!1):n.hidden=!0)}function generateAudioPlayerHTML(e){return`<div class="audio-player" data-audio-file="${e}">\n  <audio preload="metadata">\n    <source src="/content/audio/${e}" type="audio/mp4">\n    您的瀏覽器不支援音訊播放。\n  </audio>\n  <div class="audio-controls">\n    <button class="audio-btn play-pause" aria-label="播放/暫停">\n      <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M8 5v14l11-7z"/>\n      </svg>\n      <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none">\n        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>\n      </svg>\n    </button>\n    <div class="audio-progress-container">\n      <input type="range" class="audio-progress" min="0" max="100" value="0" step="0.1" aria-label="播放進度">\n      <div class="audio-time">\n        <span class="current-time">0:00</span>\n        <span class="duration">0:00</span>\n      </div>\n      <div class="playlist-info" style="display:none; font-size:0.75rem; color:var(--text-secondary, #666); margin-top:0.25rem;">\n        片段 <span class="current-part">1</span> / <span class="total-parts">1</span>\n      </div>\n    </div>\n    <div class="audio-speed">\n      <button class="speed-btn" aria-label="播放速度">1.0x</button>\n      <div class="speed-menu" style="display:none">\n        <button data-speed="0.75">0.75x</button>\n        <button data-speed="1.0" class="active">1.0x</button>\n        <button data-speed="1.25">1.25x</button>\n        <button data-speed="1.5">1.5x</button>\n        <button data-speed="2.0">2.0x</button>\n      </div>\n    </div>\n    <div class="audio-volume">\n      <button class="volume-btn" aria-label="音量">\n        <svg viewBox="0 0 24 24" fill="currentColor">\n          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>\n        </svg>\n      </button>\n      <input type="range" class="volume-slider" min="0" max="100" value="100" aria-label="音量控制">\n    </div>\n  </div>\n  <div class="audio-attribution">\n    Powered by <a href="https://notebooklm.google/" target="_blank" rel="noopener noreferrer">NotebookLM</a>. You may check facts.\n  </div>\n</div>`}const AudioPlayerManager={STORAGE_KEY_PREFIX:"audio-player-",eventHandlers:new Map,init(){const e=document.querySelector(".audio-player");if(!e)return;const t=e.querySelector("audio");if(!t)return;"true"===e.dataset.initialized&&this.cleanup(),e.dataset.initialized="true";const n=e.querySelector(".play-pause"),o=e.querySelector(".play-icon"),a=e.querySelector(".pause-icon"),r=e.querySelector(".audio-progress"),i=e.querySelector(".current-time"),s=e.querySelector(".duration"),c=e.querySelector(".speed-btn"),l=e.querySelector(".speed-menu"),d=l.querySelectorAll("[data-speed]"),u=e.querySelector(".volume-btn"),p=e.querySelector(".volume-slider"),m=extractSlugFromUrl(new URL(window.location.href)),h=this.STORAGE_KEY_PREFIX+m,g=localStorage.getItem(h+"-speed");g&&(t.playbackRate=parseFloat(g),c.textContent=g+"x",d.forEach(e=>{e.classList.toggle("active",e.dataset.speed===g)}));const y=localStorage.getItem("audio-volume");y&&(t.volume=parseFloat(y),p.value=100*parseFloat(y)),n.addEventListener("click",()=>{t.paused?t.play().catch(t=>{console.error("[AudioPlayer] 播放失敗：",t),this.showError(e,"無法播放音訊，請檢查網路連線或稍後再試。")}):t.pause()}),t.addEventListener("error",n=>{const o={1:"音訊載入被中斷",2:"網路錯誤，無法載入音訊",3:"音訊格式不支援或檔案損壞",4:"音訊來源不可用"}[t.error?t.error.code:0]||"音訊播放發生未知錯誤";console.error("[AudioPlayer] 音訊錯誤：",o,n),this.showError(e,o)}),t.addEventListener("play",()=>{o.style.display="none",a.style.display="block"}),t.addEventListener("pause",()=>{o.style.display="block",a.style.display="none"});let f=0;let v=!1;t.addEventListener("timeupdate",()=>{const e=t.currentTime/t.duration*100;if(r.value=e,i.textContent=this.formatTime(t.currentTime),this.updateProgressBar(r,e),!v){const e=Date.now();e-f>=5e3&&(localStorage.setItem(h+"-time",t.currentTime.toString()),f=e)}}),t.addEventListener("loadedmetadata",()=>{if(s.textContent=this.formatTime(t.duration),!e.classList.contains("playlist-mode")){const e=localStorage.getItem(h+"-time");if(e&&parseFloat(e)>0){const n=parseFloat(e);n<t.duration&&(t.currentTime=n)}}}),t.duration&&(s.textContent=this.formatTime(t.duration)),r.addEventListener("input",()=>{const e=r.value/100*t.duration;t.currentTime=e,this.updateProgressBar(r,r.value),i.textContent=this.formatTime(e)}),t.addEventListener("seeking",()=>{v=!0}),t.addEventListener("seeked",()=>{v=!1,localStorage.setItem(h+"-time",t.currentTime.toString()),f=Date.now()}),t.addEventListener("ended",()=>{e.classList.contains("playlist-mode")||(localStorage.removeItem(h+"-time"),r.value=0)}),c.addEventListener("click",e=>{e.stopPropagation(),l.style.display="none"===l.style.display?"block":"none"}),d.forEach(e=>{e.addEventListener("click",n=>{n.stopPropagation();const o=e.dataset.speed;t.playbackRate=parseFloat(o),c.textContent=o+"x",localStorage.setItem(h+"-speed",o),d.forEach(e=>e.classList.remove("active")),e.classList.add("active"),l.style.display="none"})});const b=()=>{l.style.display="none"};document.addEventListener("click",b),this.eventHandlers.set("closeMenu",b),p.addEventListener("input",()=>{const e=p.value/100;t.volume=e,localStorage.setItem("audio-volume",e.toString()),this.updateVolumeIcon(u,e)}),u.addEventListener("click",()=>{if(t.volume>0)t.dataset.previousVolume=t.volume.toString(),t.volume=0,p.value=0;else{const e=parseFloat(t.dataset.previousVolume||"1");t.volume=e,p.value=100*e}this.updateVolumeIcon(u,t.volume)}),this.updateVolumeIcon(u,t.volume);const S=e=>{"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&("Space"===e.code&&(e.preventDefault(),n.click()),"ArrowLeft"===e.code&&(e.preventDefault(),t.currentTime=Math.max(0,t.currentTime-10)),"ArrowRight"===e.code&&(e.preventDefault(),t.currentTime=Math.min(t.duration,t.currentTime+10)),"ArrowUp"===e.code&&(e.preventDefault(),t.volume=Math.min(1,t.volume+.1),p.value=100*t.volume,localStorage.setItem("audio-volume",t.volume.toString()),this.updateVolumeIcon(u,t.volume)),"ArrowDown"===e.code&&(e.preventDefault(),t.volume=Math.max(0,t.volume-.1),p.value=100*t.volume,localStorage.setItem("audio-volume",t.volume.toString()),this.updateVolumeIcon(u,t.volume)))};document.addEventListener("keydown",S),this.eventHandlers.set("keydown",S);const w=()=>{!isNaN(t.currentTime)&&t.currentTime>0&&localStorage.setItem(h+"-time",t.currentTime.toString())};window.addEventListener("beforeunload",w),this.eventHandlers.set("beforeunload",w),this.initPlaylist(e,t,h)},async initPlaylist(e,t,n){const o=e.dataset.audioFile;if(!o)return;const a=e.querySelector(".playlist-info"),r=e.querySelector(".current-part"),i=e.querySelector(".total-parts");let s;try{s=await this.detectPlaylist(o)}catch(e){console.error("[AudioPlayer] 播放清單初始化失敗：",e),s=[o]}if(1===s.length)return;console.log(`📻 偵測到播放清單：${s.length} 個片段`),e.classList.add("playlist-mode"),a.style.display="block",i.textContent=s.length;let c=0;r.textContent=c+1;const l=t.querySelector("source").src;s[c];l.endsWith(s[c])||await this.loadPart(t,s[c]);t.addEventListener("ended",async()=>{if(e.classList.contains("playlist-mode"))if(c++,c<s.length){console.log(`📻 自動播放下一個片段：${c+1}/${s.length}`),r.textContent=c+1,await this.loadPart(t,s[c]);const e=localStorage.getItem(n+"-speed");e&&(t.playbackRate=parseFloat(e)),t.play().catch(e=>{console.error("自動播放失敗：",e)})}else console.log("📻 播放清單結束"),e.classList.remove("playlist-mode"),localStorage.removeItem(n+"-time")})},formatTime(e){if(isNaN(e)||!isFinite(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`},updateProgressBar(e,t){const n=Math.max(0,Math.min(100,t));e.style.background=`linear-gradient(\n      to right,\n      var(--accent-color, #556bff) 0%,\n      var(--accent-color, #556bff) ${n}%,\n      var(--border-color, #e0e0e0) ${n}%,\n      var(--border-color, #e0e0e0) 100%\n    )`},updateVolumeIcon(e,t){const n=e.querySelector("svg path");n&&(0===t?n.setAttribute("d","M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"):t<.5?n.setAttribute("d","M7 9v6h4l5 5V4l-5 5H7z"):n.setAttribute("d","M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"))},async detectPlaylist(e){const t=e.replace(/\.[^/.]+$/,""),n=e.match(/\.[^/.]+$/)[0],o=`${t}-part0${n}`,a=`/content/audio/${o}`;try{if(!(await fetch(a,{method:"HEAD"})).ok)return[e]}catch(t){return console.warn("[AudioPlayer] 播放清單偵測失敗：",t),[e]}const r=async(e,o)=>{const a=[];for(let r=e;r<=o;r++){const e=`${t}-part${r}${n}`,o=`/content/audio/${e}`;a.push(fetch(o,{method:"HEAD"}).then(t=>({index:r,exists:t.ok,file:e})).catch(()=>({index:r,exists:!1,file:e})))}return Promise.all(a)},i=[o];for(let e=1;e<20;e+=5){const t=Math.min(e+5-1,19),n=await r(e,t);n.sort((e,t)=>e.index-t.index);let o=!1;for(const e of n){if(!e.exists){o=!0;break}i.push(e.file)}if(o)break}return console.log(`[AudioPlayer] 偵測到 ${i.length} 個音訊片段`),i.length>0?i:[e]},loadPart:(e,t)=>new Promise((n,o)=>{e.querySelector("source").src=`/content/audio/${t}`;const a=()=>{e.removeEventListener("loadedmetadata",a),e.removeEventListener("error",r),console.log(`✅ 片段載入完成：${t}`),n()},r=n=>{e.removeEventListener("loadedmetadata",a),e.removeEventListener("error",r),console.error(`❌ 片段載入失敗：${t}`,n),o(new Error(`Failed to load audio part: ${t}`))};e.addEventListener("loadedmetadata",a,{once:!0}),e.addEventListener("error",r,{once:!0}),e.load()}),cleanup(){this.eventHandlers.forEach((e,t)=>{"closeMenu"===t?document.removeEventListener("click",e):"keydown"===t?document.removeEventListener("keydown",e):"beforeunload"===t&&window.removeEventListener("beforeunload",e)}),this.eventHandlers.clear(),console.log("[AudioPlayer] 清理完成")},showError(e,t){let n=e.querySelector(".audio-error");n||(n=document.createElement("div"),n.className="audio-error",e.appendChild(n)),n.textContent=t,n.style.display="block",setTimeout(()=>{n&&(n.style.display="none")},5e3)}};async function renderHomepage(){const e=document.querySelector("#posts-list"),t=document.querySelector("#posts-empty"),n=document.querySelector("#posts-error");if(!e)return;e.innerHTML="",t&&(t.hidden=!0),n&&(n.hidden=!0);let o=await loadNormalizedPosts();const a=new URLSearchParams(window.location.search),r=a.get("tag"),i=a.get("category"),s=a.get("search");if(!o.length)return void(t&&(t.hidden=!1));if(r&&(o=o.filter(e=>Array.isArray(e.tags)&&e.tags.some(e=>String(e||"").toLowerCase()===r.toLowerCase()))),i&&(o=o.filter(e=>e.category&&e.category.toLowerCase()===i.toLowerCase())),s&&(o=filterPostsBySearch(o,s)),updateSearchResultsCount(o.length,s),!o.length)return void(t&&(t.textContent=s?`沒有找到包含「${s}」的文章。`:r?`沒有找到標籤「${r}」的文章。`:i?`沒有找到分類「${i}」的文章。`:"No posts yet. Add your first note in content/posts.",t.hidden=!1));const[c,...l]=o;renderFeaturedPost(c);const d=document.querySelector("#post-item-template");d&&(l.length?l.forEach(t=>{const n=d.content.cloneNode(!0),o=n.querySelector(".post-link"),a=n.querySelector(".post-meta"),r=n.querySelector(".post-summary"),i=n.querySelector(".post-card__category"),s=n.querySelector(".post-tags");if(o){o.href=slugToPath(t.slug,t.category),o.textContent=t.title||t.slug;const e=o.parentElement.querySelector(".audio-indicator");if(e&&e.remove(),t.hasAudio){const e=document.createElement("span");e.className="audio-indicator",e.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n            <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>\n          </svg>',e.setAttribute("aria-label","有語音版"),e.setAttribute("title","此文章有語音版"),o.parentElement.insertBefore(e,o.nextSibling)}}i&&(i.textContent=t.category||"Dispatch"),a&&(a.textContent=formatMetaParts(t).join(" | ")),r&&(r.textContent=t.summary||""),populateTagBadges(s,t.tags),e.appendChild(n)}):e.innerHTML="",populateCategoryList(o),populateTagCloud(o))}async function renderArticle(){let e=null;const t=window.location.pathname.split("/").filter(e=>e.trim());if(t.length>=2&&(e=t[t.length-1]),!e){const t=new URLSearchParams(window.location.search);e=t.get("slug")}const n=document.querySelector("#post-content");if(!e)return void(n&&(n.innerHTML='<p class="error">Missing post slug. Open this page from the homepage listing.</p>'));const o=await loadNormalizedPosts(),a=o.findIndex(t=>t.slug===e);if(-1===a)throw new Error(`No post with slug "${e}"`);const r=o[a],i=document.querySelector("#breadcrumb-current"),s=document.querySelector("#post-hero"),c=document.querySelector("#post-category"),l=document.querySelector("#post-title"),d=document.querySelector("#post-meta"),u=document.querySelector("#post-tags");if(i){const t=i.parentElement;let n=t.querySelector(".breadcrumb-separator");n||(n=document.createElement("span"),n.className="breadcrumb-separator",n.textContent="›",t.insertBefore(n,i)),i.textContent=r.title||e}if(applyAccentBackground(s,r),c&&(r.category?(c.textContent=r.category,c.hidden=!1):c.hidden=!0),l&&(l.textContent=r.title||e,r.hasAudio)){const e=document.createElement("span");e.className="audio-indicator audio-indicator--article",e.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n        <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>\n      </svg>',e.setAttribute("aria-label","有語音版"),e.setAttribute("title","此文章有語音版"),l.appendChild(e),setTimeout(()=>{const t=l.offsetHeight,n=parseFloat(getComputedStyle(l).lineHeight),o=parseFloat(getComputedStyle(l).fontSize);t>1.3*(isNaN(n)?1.2*o:n)&&e.classList.add("audio-indicator--compact")},0)}if(document.title=r.title?`${r.title} - b-log`:"Reading - b-log",d){d.innerHTML="";formatMetaParts(r).forEach(e=>{if(e&&e.trim()){const t=document.createElement("span");t.textContent=e,d.appendChild(t)}})}populateTagBadges(u,r.tags),await renderMarkdownContent(e,n),AudioPlayerManager.init(),updatePageMetadata(r),renderShareLinks(r),renderNavigation(o,a),renderRelatedPosts(o,r)}async function loadPostsCatalog(){const e=await fetch(`${POSTS_JSON}?t=${Date.now()}`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await readUtf8Text(e),n=JSON.parse(t);if(!Array.isArray(n))throw new Error("Invalid posts.json format");return n}async function loadNormalizedPosts(){return normalizePosts(await loadPostsCatalog())}function normalizePosts(e){return e.map(e=>{const t=parseDate(e.publishedAt),n=parseDate(e.updatedAt||e.publishedAt);return{...e,publishedDate:t,updatedDate:n}}).sort((e,t)=>{const n=e.publishedDate?e.publishedDate.getTime():0;return(t.publishedDate?t.publishedDate.getTime():0)-n})}function parseDate(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?null:t}function renderFeaturedPost(e){const t=document.querySelector("#featured"),n=document.querySelector("#hero-media"),o=document.querySelector("#hero-category"),a=document.querySelector("#hero-link"),r=document.querySelector("#hero-meta"),i=document.querySelector("#hero-summary"),s=document.querySelector("#hero-read-more"),c=document.querySelector("#hero-open-discussion");if(t){if(applyAccentBackground(n,e),t.hidden=!1,o&&(o.textContent=e.category||"Dispatch",o.hidden=!e.category),a){a.href=slugToPath(e.slug,e.category),a.textContent=e.title||e.slug;const t=a.parentElement.querySelector(".audio-indicator");if(t&&t.remove(),e.hasAudio){const e=document.createElement("span");e.className="audio-indicator audio-indicator--hero",e.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n        <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>\n      </svg>',e.setAttribute("aria-label","有語音版"),e.setAttribute("title","此文章有語音版"),a.parentElement.insertBefore(e,a.nextSibling)}}r&&(r.textContent=formatMetaParts(e).join(" | ")),i&&(i.textContent=e.summary||""),s&&(s.href=slugToPath(e.slug,e.category)),c&&(c.href=`${slugToPath(e.slug,e.category)}#comments`)}}function populateTagBadges(e,t){e&&(e.innerHTML="",Array.isArray(t)&&t.length?(e.hidden=!1,t.forEach(t=>{const n=String(t||"").trim();if(!n)return;const o=document.createElement("span");o.textContent=n,e.appendChild(o)})):e.hidden=!0)}function populateCategoryList(e){const t=document.querySelector("#category-list"),n=document.querySelector("#category-item-template");if(!t||!n)return;t.innerHTML="";const o=new Map;if(e.forEach(e=>{const t=(e.category||"Dispatch").trim();t&&o.set(t,(o.get(t)||0)+1)}),!o.size){const e=document.createElement("li");return e.textContent="No categories yet.",void t.appendChild(e)}Array.from(o.entries()).sort((e,t)=>t[1]-e[1]).forEach(([e,o])=>{const a=n.content.cloneNode(!0),r=a.querySelector(".taxonomy-link");r&&(r.textContent=`${e} (${o})`,r.href=`index.html?category=${encodeURIComponent(e)}`),t.appendChild(a)})}function populateTagCloud(e){const t=document.querySelector("#tag-cloud");if(!t)return;t.innerHTML="";const n=new Map;if(e.forEach(e=>{Array.isArray(e.tags)&&e.tags.forEach(e=>{const t=String(e||"").trim();if(!t)return;const o=t.toLowerCase(),a=n.get(o)||{label:t,count:0};a.count+=1,a.label=t,n.set(o,a)})}),!n.size){const e=document.createElement("span");return e.textContent="No tags yet.",void t.appendChild(e)}const o=Array.from(n.values()).sort((e,t)=>t.count-e.count),a=o.map(e=>e.count),r=Math.min(...a),i=Math.max(...a);o.forEach(e=>{const n=document.createElement("a");n.textContent=`#${e.label}`,n.href=`index.html?tag=${encodeURIComponent(e.label)}`;const o=i===r?.95:.85+(e.count-r)/(i-r)*.5;n.style.fontSize=`${o.toFixed(2)}rem`,t.appendChild(n)})}async function renderMarkdownContent(e,t){if(!t)return;const n=await fetch(`${POSTS_ROOT}${e}.md?t=${Date.now()}`);if(!n.ok)throw new Error(`Markdown fetch failed with status ${n.status}`);let o=await readUtf8Text(n);const a=o.split("\n");if(a[0].trim().startsWith("#")){for(a.shift();a.length>0&&""===a[0].trim();)a.shift();o=a.join("\n")}const r=o.match(/<!--\s*audio:\s*(.+?)\s*-->/);if(r){const e=generateAudioPlayerHTML(r[1]);o=o.replace(/<!--\s*audio:\s*.+?\s*-->/,e)}window.marked?t.innerHTML=window.marked.parse(o):t.textContent=o,t.querySelectorAll("img, source").forEach(e=>{const t="SOURCE"===e.tagName?"srcset":"src",n=e.getAttribute(t);n&&n.startsWith("content/")&&e.setAttribute(t,"/"+n)}),enhanceCodeBlocks(t)}function enhanceCodeBlocks(e){if(!e)return;const t=e.querySelectorAll("pre code");console.log(`Found ${t.length} code blocks to enhance`),t.forEach(e=>{const t=e.parentElement;if(t.parentElement&&t.parentElement.classList.contains("code-container"))return;const n=document.createElement("div");n.className="code-container",n.style.position="relative";const o=detectLanguage(e.textContent);if(o){const e=document.createElement("div");e.className="code-language",e.textContent=o,n.appendChild(e)}const a=document.createElement("button");a.className="code-copy-btn",a.textContent="Copy",a.setAttribute("aria-label","Copy code to clipboard"),a.style.display="flex",n.appendChild(a),t.parentNode.insertBefore(n,t),n.appendChild(t),shouldAddLineNumbers(t)&&addLineNumbers(t),setupCodeCopy(a,e),window.Prism?Prism.highlightElement(e):applyBasicSyntaxHighlighting(e,o)})}function detectLanguage(e){const t=e.trim();return t.includes("<!DOCTYPE")||t.includes("<html")?"html":t.includes("import React")||t.includes("jsx")?"jsx":t.includes("function")&&t.includes("{")?"javascript":t.includes("def ")||t.includes("import ")?"python":t.includes("public class")||t.includes("import java")?"java":t.includes("package")||t.includes("func ")||t.includes("fmt.")||t.includes("func ")?"go":t.includes("class ")&&t.includes("def ")?"python":t.includes("const ")&&t.includes("=>")||t.includes("async function")||t.includes("await ")||t.includes("app.get")||t.includes("app.post")?"javascript":t.includes("suspend fun")||t.includes("val ")||t.includes("private val")||t.includes("OkHttp")?"kotlin":t.includes("//")&&t.includes("{")?"javascript":t.includes("#")&&t.includes("def ")?"python":t.includes("\x3c!--")&&t.includes("--\x3e")?"html":null}function shouldAddLineNumbers(e){return e.textContent.split("\n").filter(e=>e.trim()).length>3}function addLineNumbers(e){const t=e.textContent.split("\n"),n=document.createElement("div");n.className="line-numbers";for(let e=1;e<=t.length;e++){const t=document.createElement("div");t.textContent=e,n.appendChild(t)}e.classList.add("line-numbers-wrapper"),e.appendChild(n)}function setupCodeCopy(e,t){e&&t&&e.addEventListener("click",async()=>{const n=t.textContent,o=e.textContent;try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(n),e.textContent="Copied!",e.classList.add("copied");else{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),e.textContent="Copied!",e.classList.add("copied")}}catch(t){return e.textContent="Failed",void setTimeout(()=>{e.textContent=o},1e3)}setTimeout(()=>{e.textContent=o,e.classList.remove("copied")},2e3)})}function applyBasicSyntaxHighlighting(e,t){if(!e)return;const n=e.textContent.split("\n").map(e=>{if(/^\s*\/\//.test(e))return`<span class="token comment">${escapeHtml(e)}</span>`;const t=e.match(/^(.+?)(?<!:)(\s+\/\/.*)$/);if(t){const[,e,n]=t;return highlightLine(e)+`<span class="token comment">${escapeHtml(n)}</span>`}return highlightLine(e)});e.innerHTML=n.join("\n")}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function highlightLine(e){if(!e.trim())return escapeHtml(e);const t=[];function n(e,n){const o=`T${t.length}X`;return t.push(`<span class="token ${n}">${e}</span>`),`___${o}___`}let o=e;return o=o.replace(/</g,e=>n("&lt;","punctuation")),o=o.replace(/>/g,e=>n("&gt;","punctuation")),o=escapeHtml(o),o=o.replace(/(["'`])(?:(?=(\\?))\2.)*?\1/g,e=>n(e,"string")),o=o.replace(/\b(function|const|let|var|if|else|for|while|return|class|extends|import|export|from|default|async|await|try|catch|finally|throw|new|this|super)\b/g,e=>n(e,"keyword")),o=o.replace(/\b(\d+)\b/g,e=>n(e,"number")),o=o.replace(/\b(document|window|console|Array|Object|String|Number|Boolean|Date|RegExp|Math|JSON)\b/g,e=>n(e,"variable")),o=o.replace(/([+\-*/%=!&|]{1,3}|[;:,(){}[\]])/g,'<span class="token punctuation">$1</span>'),t.forEach((e,t)=>{const n=`T${t}X`;o=o.split(`___${n}___`).join(e)}),o}function renderShareLinks(e){const t=document.querySelector("#share-links");if(!t)return;t.innerHTML="";const n=new URL(window.location.href);n.hash="";const o=e.title||"New post on b-log",a=n.toString();[{label:"Share on X",href:`https://twitter.com/intent/tweet?text=${encodeURIComponent(o)}&url=${encodeURIComponent(a)}`,external:!0},{label:"Share on Facebook",href:`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(a)}`,external:!0},{label:"Copy link",href:"#",action:"copy-link"}].forEach(e=>{const n=document.createElement("a");n.textContent=e.label,e.external?(n.href=e.href,n.target="_blank",n.rel="noopener noreferrer"):n.href=e.href,e.action&&(n.dataset.action=e.action),t.appendChild(n)}),setupCopyLink(t,a)}function renderNavigation(e,t){const n=document.querySelector("#post-nav-prev"),o=document.querySelector("#post-nav-next");if(!n||!o)return;const a=t>0?e[t-1]:null,r=t<e.length-1?e[t+1]:null;configureNavLink(n,a,"Newer post"),configureNavLink(o,r,"Older post")}function configureNavLink(e,t,n){e&&(t?(e.textContent=`${n}: ${t.title||t.slug}`,e.href=slugToPath(t.slug,t.category),e.classList.remove("is-disabled"),e.removeAttribute("aria-disabled"),e.tabIndex=0):(e.textContent=`No ${n.toLowerCase()} yet`,e.classList.add("is-disabled"),e.setAttribute("aria-disabled","true"),e.removeAttribute("href"),e.tabIndex=-1))}function renderRelatedPosts(e,t){const n=document.querySelector("#related-list"),o=document.querySelector("#latest-sidebar");if(n){n.innerHTML="";const o=e.filter(e=>e.slug!==t.slug).filter(e=>!(!t.category||!e.category||e.category!==t.category)||!(!Array.isArray(t.tags)||!Array.isArray(e.tags))&&t.tags.some(t=>e.tags.includes(t))).slice(0,3);if(o.length)o.forEach(e=>{n.appendChild(buildRelatedItem(e))});else{const e=document.createElement("li");e.textContent="More posts arriving soon.",n.appendChild(e)}}if(o){o.innerHTML="";e.filter(e=>e.slug!==t.slug).slice(0,3).forEach(e=>{o.appendChild(buildRelatedItem(e))})}const a=document.querySelector("#comments-link");a&&(a.href=`https://github.com/jason5545/b-log/issues/new?title=${encodeURIComponent(`Comment: ${t.title||t.slug}`)}&labels=discussion`)}function buildRelatedItem(e){const t=document.createElement("li"),n=document.createElement("a");if(n.href=slugToPath(e.slug,e.category),n.textContent=e.title||e.slug,t.appendChild(n),e.publishedDate){const n=document.createElement("small");n.textContent=` - ${formatDate(e.publishedDate)}`,t.appendChild(n)}return t}function formatMetaParts(e){const t=[];return e.author&&t.push(`By ${e.author}`),e.publishedDate&&t.push(`Published ${formatDate(e.publishedDate)}`),e.updatedDate&&e.publishedDate&&e.updatedDate.getTime()!==e.publishedDate.getTime()&&t.push(`Updated ${formatDate(e.updatedDate)}`),e.readingTime&&t.push(e.readingTime),t}function formatDate(e){return e?e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}):""}function applyAccentBackground(e,t){if(!e)return;if(t.coverImage)return e.style.backgroundImage=`url(${t.coverImage})`,e.style.backgroundSize="cover",void(e.style.backgroundPosition="center");const n=t.accentColor||"#556bff",o=`linear-gradient(135deg, ${shadeColor(n,-15)} 0%, ${n} 50%, ${shadeColor(n,25)} 100%)`;e.style.backgroundImage=o}function shadeColor(e,t){const n=hexToRgb(e);if(!n)return e;const o=(100+t)/100;return rgbToHex({r:clamp(Math.round(n.r*o),0,255),g:clamp(Math.round(n.g*o),0,255),b:clamp(Math.round(n.b*o),0,255)})}function hexToRgb(e){if("string"!=typeof e)return null;let t=e.trim().replace("#","");if(![3,6].includes(t.length))return null;3===t.length&&(t=t.split("").map(e=>e+e).join(""));const n=Number.parseInt(t,16);return Number.isNaN(n)?null:{r:n>>16&255,g:n>>8&255,b:255&n}}function rgbToHex({r:e,g:t,b:n}){const o=e=>e.toString(16).padStart(2,"0");return`#${o(e)}${o(t)}${o(n)}`}function clamp(e,t,n){return Math.min(Math.max(e,t),n)}function slugToPath(e,t){const n=categoryMapping||{"AI 分析":"ai-analysis","技術開發":"tech-development","技術分析":"tech-analysis","開發哲學":"dev-philosophy","生活記事":"life-stories","商業觀察":"business-insights","文化觀察":"cultural-insights"};if(t&&n[t]){return`/${n[t]}/${e}/`}return`/post.html?slug=${encodeURIComponent(e)}`}function setupCopyLink(e,t){e&&!e.dataset.copyHandlerAttached&&(e.dataset.copyHandlerAttached="true",e.addEventListener("click",async e=>{const n=e.target.closest('[data-action="copy-link"]');if(!n)return;e.preventDefault();const o=n.textContent;try{if(!navigator.clipboard||!navigator.clipboard.writeText)throw new Error("Clipboard API unavailable");await navigator.clipboard.writeText(t),n.textContent="Link copied"}catch(e){window.prompt("Copy this URL",t),n.textContent="Link copied"}setTimeout(()=>{n.textContent=o},2e3)}))}function updatePageMetadata(e){const t="https://b-log.to/",n=slugToPath(e.slug,e.category),o=`${t}${n.startsWith("/")?n.substring(1):n}`;document.title=e.title?`${e.title} - b-log`:"Reading - b-log";const a=document.querySelector("#canonical-url");a&&(a.href=o);const r=document.querySelector('meta[name="description"]');r&&(r.content=e.summary||"b-log 是一個雙重用途的內容系統：既是分享見解的部落格，也是管理項目的待辦清單。");const i=document.querySelector("#meta-keywords");if(i){const t=Array.isArray(e.tags)?e.tags.join(", "):"";i.content=t}updateMetaProperty("og:url",o),updateMetaProperty("og:title",e.title||"Untitled Post"),updateMetaProperty("og:description",e.summary||""),updateMetaProperty("og:image",getPostImage(e,t)),updateMetaProperty("article:author",e.author||"Jason Chien"),updateMetaProperty("article:published_time",e.publishedAt||""),updateMetaProperty("article:modified_time",e.updatedAt||e.publishedAt||""),updateMetaProperty("article:section",e.category||""),Array.isArray(e.tags)&&e.tags.length>0&&(document.querySelectorAll('meta[property^="article:tag"]').forEach(e=>e.remove()),e.tags.forEach(e=>{if(e){const t=document.createElement("meta");t.setAttribute("property","article:tag"),t.content=e,document.head.appendChild(t)}})),updateMetaProperty("twitter:url",o),updateMetaProperty("twitter:title",e.title||"Untitled Post"),updateMetaProperty("twitter:description",e.summary||""),updateMetaProperty("twitter:image",getPostImage(e,t))}function updateMetaProperty(e,t){let n=document.querySelector(`meta[property="${e}"]`);n||(n=document.querySelector(`meta[name="${e}"]`)),n&&(n.content=t)}function getPostImage(e,t){if(e.coverImage)return e.coverImage.startsWith("/")?`${t}${e.coverImage.substring(1)}`:e.coverImage.startsWith("http")?e.coverImage:`${t}${e.coverImage}`;e.accentColor;return`https://og-image.vercel.app/${encodeURIComponent(e.title||"Untitled Post")}.png?theme=light&md=1&fontSize=100px&images=https%3A%2F%2Fb-log.to%2Ffavicon.ico`}function setupViewTransitionNames(){const e=document.querySelector("#hero-link");e&&(e.style.viewTransitionName="featured-title"),document.querySelectorAll(".post-card").forEach((e,t)=>{const n=e.querySelector(".post-link");if(n){const o=extractSlugFromUrl(new URL(n.href,window.location.origin));e.style.viewTransitionName=o?`post-card-${o}`:`post-card-${t}`}});const t=document.querySelector("#post-title");if(t){const e=extractSlugFromUrl(new URL(window.location.href));e&&(t.style.viewTransitionName=`post-title-${e}`)}const n=document.querySelector("#post-hero");if(n){const e=extractSlugFromUrl(new URL(window.location.href));e&&(n.style.viewTransitionName=`post-hero-${e}`)}}function extractSlugFromUrl(e){let t=new URLSearchParams(e.search).get("slug");if(!t){const n=e.pathname.split("/").filter(e=>e&&"index.html"!==e&&"post.html"!==e);n.length>=2&&(t=n[n.length-1])}return t}document.addEventListener("DOMContentLoaded",()=>{ThemeManager.init(),AudioPlayerManager.init(),loadCategoryMapping().catch(e=>{console.warn("[init] failed to load category mapping",e)});const e=document.body.classList;e.contains("home")&&(initSearch(),renderHomepage().catch(e=>{console.error("[home] failed to render",e);const t=document.querySelector("#posts-error");t&&(t.hidden=!1)})),e.contains("post-page")&&renderArticle().catch(e=>{console.error("[post] failed to render",e);const t=document.querySelector("#post-content");t&&(t.innerHTML='<p class="error">Could not load this post. Check the metadata and Markdown file.</p>')})}),document.addEventListener("DOMContentLoaded",()=>{setupViewTransitionNames()});