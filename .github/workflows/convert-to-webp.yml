name: è‡ªå‹•è½‰æ›åœ–ç‰‡ç‚º WebP

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ content/img/ ç›®éŒ„ä¸‹çš„åœ–ç‰‡è¢«æ¨é€æ™‚
on:
  push:
    branches:
      - main
    paths:
      - 'content/img/**/*.jpg'
      - 'content/img/**/*.jpeg'
      - 'content/img/**/*.png'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­å®šæ¬Šé™
permissions:
  contents: write

jobs:
  convert-to-webp:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è¨­å®š Node.js
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. å®‰è£ sharpï¼ˆåœ–ç‰‡è™•ç†å¥—ä»¶ï¼‰
      - name: å®‰è£ sharp
        run: npm install sharp

      # 4. è½‰æ›åœ–ç‰‡ç‚º WebP
      - name: è½‰æ›åœ–ç‰‡ç‚º WebP
        run: node scripts/convert-to-webp.js

      # 5. æ›´æ–° Markdown æ–‡ç« ä¸­çš„åœ–ç‰‡åƒç…§
      - name: æ›´æ–° Markdown åœ–ç‰‡åƒç…§
        run: node scripts/update-image-refs.js

      # 6. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      - name: æª¢æŸ¥è®Šæ›´
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # 7. æäº¤ä¸¦æ¨é€è®Šæ›´
      - name: æäº¤è®Šæ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/img/ content/posts/
          git commit -m "ğŸ–¼ï¸ è‡ªå‹•è½‰æ›åœ–ç‰‡ç‚º WebP æ ¼å¼

          - ä½¿ç”¨ sharp å¥—ä»¶è½‰æ›ç‚ºé«˜å“è³ª WebP
          - å“è³ªè¨­å®šï¼š85
          - æ›´æ–° Markdown æ–‡ç« ä½¿ç”¨ <picture> æ¨™ç±¤
          - ä¿ç•™åŸå§‹åœ–ç‰‡ä½œç‚ºé™ç´šæ–¹æ¡ˆ"
          git push

      # 8. é¡¯ç¤ºçµæœ
      - name: é¡¯ç¤ºçµæœ
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "âœ… æ²’æœ‰éœ€è¦è½‰æ›çš„åœ–ç‰‡"
